<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>SimpleRAK</title>
        <!--Import materialize.css-->
        <link type="text/css" rel="stylesheet" href="lib/materialize/css/materialize.min.css"  media="screen,projection"/>
        <link type="text/css" rel="stylesheet" href="res/css/simplerak.css"/>

        <!--Let browser know website is optimized for mobile-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    </head>

    <body>
        <nav>
            <div class="nav-wrapper light-green">
                <a href="#" class="brand-logo center">SimpleRAK</a>
                <ul id="nav-mobile" class="left">
                    <li><a id="show_menu" data-activates="global-menu"  href="#"><i class="mdi-navigation-menu"></i></a></li>
                </ul>
            </div>
        </nav>
        <ul id="global-menu" class="side-nav fixed">
            <li><a href="index.html">Menu</a></li>
            <li class="active"><a href="#" >Mon Compte</a></li>
            <li><a href="configuration.html">Paramètres</a></li>
        </ul>
        <div class="progress" style="margin-top: 0;">
            <div class="indeterminate"></div>
        </div>  
        <div id="container">

        </div>  

        <script type="text/javascript" src="lib/jquery-2.1.3.min.js"></script>
        <script type="text/javascript" src="lib/materialize/js/materialize.min.js"></script>

        <script type="text/javascript" src="lib/md5.js"></script>

        <script type="text/javascript" src="res/js/simplerak.js"></script>

        <script>
            $(function () {
                var url = "https://services.ard.fr/fr/espaces-clients/etablissements/enst.html"
                $.get(url, function (d) {
                    if ($(d).find("#user").length) {
                        //We are already connected
                        //alert('we are already connected')
                        //alert(d);
                        parse_page(d)
                    } else {
                        d = $(d).find(".tx-newloginbox-pi1 form").serializeArray()
                        var form = {};
                        $.map(d, function (n, i) {
                            form[n['name']] = n['value'];
                        });
                        //TODO use enc_pass
                        if (localStorage.user && localStorage.pass) {
                            form.user = localStorage.user;
                            form.pass = localStorage.pass;
                        } else {
                            form.user = prompt("User", "");
                            form.pass = prompt("Password", "");
                            //TODO onlyif validate
                            localStorage.user = form.user;
                            localStorage.pass = form.pass;
                        }
                        superchallenge_pass(form)
                        alert(JSON.stringify(form))
                        $.post(url, form, function (d) {
                            parse_page(d);
                        })
                    }
                });
                function superchallenge_pass(form) {
                    if (form.pass) {
                        var enc_pass = MD5(form.pass);
                        var str = form.user + ":" + enc_pass + ":" + form.challenge;
                        form.pass = MD5(str);
                        return true;
                    } else {
                        return false;
                    }
                }
                function parse_page(d) {
                    //TODO check if we are connectedd
                    //alert(d);
                    $("#container").append('<h5>' + $(d).find('#user').html().replace(/Bonjour /g, '') + '</h5>')
                    $(".progress").hide()
                    $.get("https://services.ard.fr/fr/espaces-clients/etablissements/enst/menu-utilisateur/recharger-mes-porte-monnaie.html", function (d) {
//                        alert(d)
                        $("#container").append('<p> Solde : ' + $(d).find(".dernier_solde").html() + '</p>')
                    });
                    $.get("https://services.ard.fr/fr/espaces-clients/etablissements/enst/menu-utilisateur/mes-dernieres-operations.html?no_cache=1", function (d) {
//                        alert(d)
//                        $("#container").append('<p> Solde : ' + $(d).find(".dernier_solde").html() + '</p>')

                        $("#container").append('<p> Dernière transaction : </p>')
                        $("#container").append($(d).find("#tx_ardrecharge>table").html())
                        /*                 
                         $("#container").append('<p> Dernière transaction : <ul id="transcations"></ul></p>')
                         /*                
                         $(d).find("#tx_ardrecharge>table>toby>tr").each(function (){
                         $
                         });
                         */
                    });
                    //https://services.ard.fr/fr/espaces-clients/etablissements/enst/menu-utilisateur/mes-derniers-rechargements-en-ligne.html?no_cache=1
                    $.get("https://services.ard.fr/fr/espaces-clients/etablissements/enst/menu-utilisateur/mes-derniers-rechargements-en-ligne.html?no_cache=1", function (d) {
                        $("#container").append('<p> Derniers rechargements : </p>')
                        $("#container").append($(d).find("#tx_ardrecharge>table").html())
                        /*                 
                         $("#container").append('<p> Dernière transaction : <ul id="transcations"></ul></p>')
                         /*                
                         $(d).find("#tx_ardrecharge>table>toby>tr").each(function (){
                         $
                         });
                         */
                    });
                }
                /*
                 */
            });
        </script>

    </body>
</html>
